<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <title>Benutzerverwaltung</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    body{background:#121212;color:#fff;font-family:Arial,Helvetica,sans-serif;margin:0;min-height:100vh}
    header{background:#1f1f1f;padding:1rem;text-align:center;font-weight:bold}
    .container{max-width:900px;margin:0 auto;padding:1rem}
    table{width:100%;border-collapse:collapse;background:#1b1b1b}
    th,td{padding:.75rem;border-bottom:1px solid #333}
    tr:hover{background:#232323}
    input,select,button{padding:.5rem;border:none;border-radius:6px;background:#2a2a2a;color:#fff}
    button.primary{background:#2f6fed}
    button.danger{background:#a33}
    .row{display:flex;gap:.5rem;flex-wrap:wrap;margin:.75rem 0}
    .note{opacity:.8}
  </style>
</head>
<body>
  <header>üëë Benutzerverwaltung</header>
  <div class="container">
    <div class="row">
      <input id="newUser" placeholder="Benutzername">
      <input id="newPass" placeholder="Passwort" type="password">
      <select id="newRole">
        <option value="viewer">viewer</option>
        <option value="editor">editor</option>
        <option value="admin">admin</option>
      </select>
      <button class="primary" onclick="createUser()">+ Benutzer anlegen</button>
      <button onclick="back()">‚Üê Zur √úbersicht</button>
    </div>

    <p class="note">Hinweis: Du kannst Rollen √§ndern, Passw√∂rter setzen oder Benutzer l√∂schen. Deinen eigenen Admin-Account kannst du nicht l√∂schen.</p>

    <table id="tbl">
      <thead>
        <tr><th>ID</th><th>Benutzername</th><th>Rolle</th><th>Aktionen</th></tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>
<script>
async function back(){ location.href='home.html'; }
async function fetchUsers(){
  const r = await fetch('/api/admin/users');
  if(!r.ok){ if(r.status===401) location.href='login.html'; else alert('Kein Zugriff'); return; }
  const data = await r.json();
  const tbody = document.querySelector('#tbl tbody');
  tbody.innerHTML = '';
  data.users.forEach(u=>{
    const tr = document.createElement('tr');
    tr.innerHTML = \`
      <td>\${u.id}</td>
      <td>\${u.username}</td>
      <td>
        <select data-id="\${u.id}" onchange="changeRole(event)">
          <option \${u.role==='viewer'?'selected':''} value="viewer">viewer</option>
          <option \${u.role==='editor'?'selected':''} value="editor">editor</option>
          <option \${u.role==='admin'?'selected':''} value="admin">admin</option>
        </select>
      </td>
      <td>
        <button onclick="resetPw(\${u.id})">Passwort setzen</button>
        <button class="danger" onclick="delUser(\${u.id})">L√∂schen</button>
      </td>
    \`;
    tbody.appendChild(tr);
  });
}
async function createUser(){
  const username = document.getElementById('newUser').value.trim();
  const password = document.getElementById('newPass').value;
  const role = document.getElementById('newRole').value;
  if(!username || !password) return alert('Bitte Benutzername & Passwort eingeben');
  const r = await fetch('/api/admin/users',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({username,password,role})});
  const d = await r.json();
  if(!r.ok || !d.success){ alert(d.error||'Fehler'); return; }
  document.getElementById('newUser').value=''; document.getElementById('newPass').value='';
  fetchUsers();
}
async function changeRole(e){
  const id = e.target.getAttribute('data-id');
  const role = e.target.value;
  const r = await fetch('/api/admin/users/'+id,{method:'PATCH',headers:{'Content-Type':'application/json'},body:JSON.stringify({role})});
  if(!r.ok){ alert('Fehler beim √Ñndern der Rolle'); }
}
async function resetPw(id){
  const pw = prompt('Neues Passwort eingeben:');
  if(!pw) return;
  const r = await fetch('/api/admin/users/'+id,{method:'PATCH',headers:{'Content-Type':'application/json'},body:JSON.stringify({password:pw})});
  if(!r.ok){ alert('Fehler beim Setzen des Passworts'); }
}
async function delUser(id){
  if(!confirm('Benutzer wirklich l√∂schen?')) return;
  const r = await fetch('/api/admin/users/'+id,{method:'DELETE'});
  const d = await r.json();
  if(!r.ok || !d.success){ alert(d.error||'Fehler beim L√∂schen'); }
  fetchUsers();
}
fetchUsers();
</script>
</body>
</html>
