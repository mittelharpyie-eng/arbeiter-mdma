<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Arbeiter MDMA – Master Dashboard</title>
<script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-black text-white min-h-screen">
<header class="p-4 bg-neutral-900 flex items-center justify-between">
  <h1 class="font-bold text-xl">Master Dashboard – Alle Akten</h1>
  <button id="logout" class="px-3 py-2 rounded-xl bg-neutral-800 hover:bg-neutral-700">Logout</button>
</header>
<main class="p-6">
  <input id="filterInput" placeholder="Filter (z.B. Name, Zugehörigkeit)" class="w-full p-2 mb-3 rounded-xl bg-neutral-800 outline-none text-white">
  <div class="overflow-x-auto">
    <table class="w-full text-left border-collapse">
      <thead>
        <tr class="border-b border-neutral-700">
          <th class="p-2 cursor-pointer" onclick="sortTable(0)">ID</th>
          <th class="p-2 cursor-pointer" onclick="sortTable(1)">Name</th>
          <th class="p-2 cursor-pointer" onclick="sortTable(2)">Vorname</th>
          <th class="p-2 cursor-pointer" onclick="sortTable(3)">Geburtstag</th>
          <th class="p-2">Zugehörigkeit</th>
          <th class="p-2">Arbeiter von</th>
          <th class="p-2">Passwort</th>
          <th class="p-2">Notizen</th>
          <th class="p-2">Erstellt</th>
        </tr>
      </thead>
      <tbody id="aktenBody"></tbody>
    </table>
  </div>
</main>
<script>
async function ladeAkteUebersicht() {
  const res = await fetch('/api/akten/uebersicht', { credentials: 'include' });
  if(!res.ok) { alert('Nicht autorisiert oder Fehler'); return; }
  const result = await res.json();
  const tbody = document.getElementById('aktenBody');
  tbody.innerHTML='';
  result.akten.forEach(a=>{
    const tr = document.createElement('tr');
    tr.className='border-b border-neutral-700 hover:bg-neutral-800';
    tr.innerHTML=`
      <td class="p-2">${a.id}</td>
      <td class="p-2">${a.name}</td>
      <td class="p-2">${a.vorname}</td>
      <td class="p-2">${a.geburtstag}</td>
      <td class="p-2">${a.zugehoerigkeit}</td>
      <td class="p-2">${a.arbeiterVon}</td>
      <td class="p-2">${a.passwort}</td>
      <td class="p-2" contenteditable='true' onblur='updateNotizen(${a.id},this)'>${a.notizen}</td>
      <td class="p-2">${a.createdAt}</td>
    `;
    tbody.appendChild(tr);
  });
}

function updateNotizen(id,cell){
  fetch(`/api/akten/${id}/updateNotizen`, {
    method:'POST',
    headers:{'Content-Type':'application/json'},
    credentials:'include',
    body:JSON.stringify({notizen:cell.textContent})
  });
}

document.getElementById('filterInput').addEventListener('input',()=>{
  const filter = document.getElementById('filterInput').value.toLowerCase();
  document.querySelectorAll('#aktenBody tr').forEach(row=>{
    row.style.display=Array.from(row.cells).some(c=>c.textContent.toLowerCase().includes(filter))?'':'none';
  });
});

function sortTable(colIndex){
  const tbody = document.getElementById('aktenBody');
  const rows = Array.from(tbody.querySelectorAll('tr'));
  const sorted = rows.sort((a,b)=>a.cells[colIndex].textContent.localeCompare(b.cells[colIndex].textContent,{numeric:true}));
  tbody.innerHTML='';
  sorted.forEach(r=>tbody.appendChild(r));
}

document.getElementById('logout').addEventListener('click',async()=>{
  await fetch('/api/logout',{method:'POST',credentials:'include'});
  window.location.href='/';
});

ladeAkteUebersicht();
</script>
</body>
</html>